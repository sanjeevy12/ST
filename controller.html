<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stranger Lights — Controller</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#071018;color:#e6f6ff;padding:18px}
  .wrap{max-width:900px;margin:0 auto}
  h1{text-align:center}
  .controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px}
  select,input,button{padding:8px 10px;border-radius:6px;border:1px solid #2b6;background:#062b2b;color:#fff}
  input[type="text"]{min-width:260px}
  .info{margin-top:12px;color:#aaddff;text-align:center}
  .preview{display:grid;grid-template-columns:repeat(10,56px);gap:8px;justify-content:center;margin-top:10px}
  .preview .cell{width:48px;height:48px;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;border-radius:6px}
  .saved-list{max-height:160px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:6px}
  nav{display:flex;justify-content:center;gap:12px;margin-bottom:8px}
  nav a{color:#9fe;text-decoration:none}
</style>
</head>
<body>
<nav>
  <a href="/ST/index.html" target="_blank">Viewer</a>
  <a href="/ST/controller.html" target="_blank">Controller</a>
</nav>

<div class="wrap">
  <h1>Stranger Lights — Controller</h1>

  <div class="controls">
    <select id="modeSel">
      <option value="0">All Blink</option>
      <option value="1">Random Blink</option>
      <option value="2">Custom Word</option>
      <option value="3">Scroll</option>
    </select>

    <input id="speed" type="number" min="20" max="5000" value="300" /> ms

    <input id="word" type="text" placeholder="Type custom word (A–Z only)" value="HELLO" />

    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <button id="pushInstant">Push Now</button>
  </div>

  <div class="info">This page writes <b>/state</b> to your Firebase Realtime Database. Open <b>Viewer</b> to watch the mirror live.</div>

  <div style="margin-top:14px">
    <label>Preview</label>
    <div id="preview" class="preview"></div>
  </div>

  <div style="margin-top:12px">
    <label>Saved Words</label>
    <div class="saved-list" id="savedList"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="saveInput" type="text" placeholder="word to save" />
      <button id="saveWord">Save</button>
    </div>
  </div>
</div>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/9.32.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.32.0/firebase-database-compat.js"></script>

<script>
// ===== FIREBASE CONFIG (stranger-things-ce82d) =====
const firebaseConfig = {
  apiKey: "AIzaSyAfPaTHjXVbvduLyNCpKkA5gD6QYzn-56c",
  authDomain: "stranger-things-ce82d.firebaseapp.com",
  databaseURL: "https://stranger-things-ce82d-default-rtdb.firebaseio.com",
  projectId: "stranger-things-ce82d",
  storageBucket: "stranger-things-ce82d.appspot.com",
  messagingSenderId: "855730758180",
  appId: "1:855730758180:web:08558e3ce2011336996eb1"
};
// ===================================================

firebase.initializeApp(firebaseConfig);
console.log("Firebase initialized (controller)", firebaseConfig.projectId);

const db = firebase.database();
const stateRef = db.ref("/state");

// Build preview A–Z
const preview = document.getElementById('preview');
const previewCells = [];
for (let i=0;i<26;i++){
  const div = document.createElement('div');
  div.className = 'cell';
  div.textContent = String.fromCharCode(65+i);
  preview.appendChild(div);
  previewCells.push(div);
}

function clearPreview(){ previewCells.forEach(c=>c.style.background='#111'); }
function setPreviewIndex(i){ clearPreview(); if (i>=0 && i<26) previewCells[i].style.background='#ff4b4b'; }
function setPreviewMask(mask){
  for(let i=0;i<26;i++) previewCells[i].style.background = (mask & (1<<i)) ? '#ff4b4b' : '#111';
}

function pushState(obj){
  obj.timestamp = Date.now();
  stateRef.set(obj)
    .then(()=> console.log("State pushed:", obj))
    .catch(e=> console.error("Push failed:", e));
}

// Controller logic
let running=false;
let loopTimer=null;
let curIdx=0;

function stepOnce(){
  const mode = Number(document.getElementById("modeSel").value);
  const speed = Number(document.getElementById("speed").value) || 300;
  const word = (document.getElementById("word").value||'').toUpperCase().replace(/[^A-Z ]/g,'').trim();

  if (mode === 0){
    const mask = (curIdx % 2 === 0) ? ((1<<26)-1) : 0;
    setPreviewMask(mask);
    pushState({ mode, speed, mask, word });
    curIdx++;
    return;
  }

  if (mode === 1){
    let mask = 0;
    for (let i=0;i<26;i++) if (Math.random() < 0.35) mask |= (1<<i);
    setPreviewMask(mask);
    pushState({ mode, speed, mask, word });
    return;
  }

  if (mode === 2){
    if (!word){ pushState({ mode, speed, currentIndex:-1, word: '' }); return; }
    const idx = word[curIdx % word.length].charCodeAt(0) - 65;
    setPreviewIndex(idx);
    pushState({ mode, speed, currentIndex: idx, word });
    curIdx++;
    return;
  }

  if (mode === 3){
    if (!word){ pushState({ mode, speed, currentIndex:-1, word: '' }); return; }
    const idx = word[curIdx % word.length].charCodeAt(0) - 65;
    setPreviewIndex(idx);
    pushState({ mode, speed, currentIndex: idx, word });
    curIdx++;
    return;
  }
}

function startLoop(){
  if (running) return;
  running = true; curIdx = 0;
  (function run(){
    if (!running) return;
    stepOnce();
    loopTimer = setTimeout(run, Math.max(40, Number(document.getElementById("speed").value) || 300));
  })();
}

function stopLoop(){
  running = false;
  if (loopTimer) clearTimeout(loopTimer);
}

document.getElementById("startBtn").addEventListener('click', startLoop);
document.getElementById("stopBtn").addEventListener('click', stopLoop);
document.getElementById("pushInstant").addEventListener('click', stepOnce);

// Saved words
const savedList = document.getElementById('savedList');
let saved = JSON.parse(localStorage.getItem("stranger_saved_v1") || "[]");

function refreshSaved(){
  savedList.innerHTML = "";
  saved.forEach((w,i)=>{
    const div = document.createElement("div");
    div.style.display = 'flex';
    div.style.justifyContent = 'space-between';
    div.style.alignItems = 'center';
    div.style.marginBottom = '6px';
    div.innerHTML = `<span>${w}</span>
      <span>
        <button data-use="${i}">Use</button>
        <button data-del="${i}">Del</button>
      </span>`;
    savedList.appendChild(div);
  });
  savedList.querySelectorAll('button[data-use]').forEach(b=>{
    b.addEventListener('click', e=> { const i = Number(b.dataset.use); document.getElementById('word').value = saved[i]; });
  });
  savedList.querySelectorAll('button[data-del]').forEach(b=>{
    b.addEventListener('click', e=> { const i = Number(b.dataset.del); saved.splice(i,1); localStorage.setItem('stranger_saved_v1', JSON.stringify(saved)); refreshSaved(); });
  });
}
document.getElementById('saveWord').addEventListener('click', ()=>{
  const v = (document.getElementById('saveInput').value||'').toUpperCase().replace(/[^A-Z ]/g,'').trim();
  if (!v) return alert('Enter a word');
  saved.unshift(v);
  saved = Array.from(new Set(saved)).slice(0,30);
  localStorage.setItem('stranger_saved_v1', JSON.stringify(saved));
  refreshSaved();
});
refreshSaved();

</script>
</body>
</html>
