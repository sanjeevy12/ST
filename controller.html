<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stranger Lights — Controller</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#071018;color:#e6f6ff;padding:18px}
  .wrap{max-width:900px;margin:0 auto}
  h1{text-align:center}
  .controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px}
  select,input,button{padding:8px 10px;border-radius:6px;border:1px solid #2b6;background:#062b2b;color:#fff}
  input[type="text"]{min-width:260px}
  .info{margin-top:12px;color:#aaddff;text-align:center}
  .preview{display:grid;grid-template-columns:repeat(10,56px);gap:8px;justify-content:center;margin-top:10px}
  .preview .cell{width:48px;height:48px;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;border-radius:6px}
  .saved-list{max-height:160px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Stranger Lights — Controller (Emulator)</h1>

  <div class="controls">
    <select id="modeSel">
      <option value="0">All Blink</option>
      <option value="1">Random Blink</option>
      <option value="2">Custom Word</option>
      <option value="3">Scroll</option>
    </select>

    <input id="speed" type="number" min="20" max="5000" value="300" /> ms

    <input id="word" type="text" placeholder="Type custom word (A–Z only)" value="HELLO" />

    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <button id="pushInstant">Push Now</button>
  </div>

  <div class="info">This page writes `/state` to your Firebase DB. Open viewer page to watch the mirror live.</div>

  <div style="margin-top:14px">
    <label>Preview</label>
    <div id="preview" class="preview"></div>
  </div>

  <div style="margin-top:12px">
    <label>Saved Words</label>
    <div class="saved-list" id="savedList"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="saveInput" type="text" placeholder="word to save" />
      <button id="saveWord">Save</button>
    </div>
  </div>
</div>

<!-- Firebase libs -->
<script src="https://www.gstatic.com/firebasejs/9.32.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.32.0/firebase-database-compat.js"></script>

<script>
// ======= REPLACE WITH YOUR FIREBASE CONFIG =======
const firebaseConfig = {
  apiKey: "AIzaSyC5DEtnD9UThmAblQ1iF5YXQypXtfVCp_s",
  authDomain: "stranger-things-c37aa.firebaseapp.com",
  projectId: "stranger-things-c37aa",
  storageBucket: "stranger-things-c37aa.firebasestorage.app",
  messagingSenderId: "841392728122",
  appId: "1:841392728122:web:64dd307f50769d03eb6d03",
  measurementId: "G-278D2DZNSB"
};
// =================================================

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const stateRef = db.ref('/state');

// build preview board
const preview = document.getElementById('preview');
const previewCells = [];
for (let i=0;i<26;i++){
  const div = document.createElement('div');
  div.className = 'cell';
  div.textContent = String.fromCharCode(65+i);
  preview.appendChild(div); previewCells.push(div);
}

// controls
const modeSel = document.getElementById('modeSel');
const speedEl = document.getElementById('speed');
const wordEl = document.getElementById('word');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const pushBtn = document.getElementById('pushInstant');

let running=false;
let loopTimer=null;
let curIdx=0;

function clearPreview(){ previewCells.forEach(c=>c.style.background='#111'); }
function setPreviewIndex(i){ clearPreview(); if (i>=0 && i<26) previewCells[i].style.background='#ff4b4b'; }
function setPreviewMask(mask){
  for(let i=0;i<26;i++) previewCells[i].style.background = (mask & (1<<i)) ? '#ff4b4b' : '#111';
}

function pushState(obj){
  obj.timestamp = Date.now();
  stateRef.set(obj).catch(err=>console.error('Firebase write error',err));
}

function stepOnce(){
  const mode = Number(modeSel.value);
  const speed = Number(speedEl.value) || 300;
  const word = (wordEl.value||'').toUpperCase().replace(/[^A-Z ]/g,'').trim();

  if (mode === 0){ // all blink: alternate mask all-on / all-off
    const isOn = (curIdx%2)==0;
    const mask = isOn ? ((1<<26)-1) : 0;
    setPreviewMask(mask);
    pushState({ mode:0, speed, mask, word:word });
    curIdx++;
    return;
  }

  if (mode === 1){ // random
    let mask = 0;
    for (let i=0;i<26;i++) if (Math.random() < 0.35) mask |= (1<<i);
    setPreviewMask(mask);
    pushState({ mode:1, speed, mask, word:word });
    return;
  }

  if (mode === 2){ // custom word sequence
    if (!word) { pushState({ mode:2, speed, currentIndex:-1, word:'' }); return; }
    const charIndex = curIdx % word.length;
    const ch = word[charIndex];
    const idx = (ch>='A' && ch<='Z') ? (ch.charCodeAt(0)-65) : -1;
    setPreviewIndex(idx>=0?idx:-1);
    pushState({ mode:2, speed, currentIndex: (idx>=0?idx:-1), word:word });
    curIdx++;
    return;
  }

  if (mode === 3){ // scroll
    if (!word) { pushState({ mode:3, speed, currentIndex:-1, word:'' }); return; }
    const idx = curIdx % word.length;
    const ch = word[idx];
    const i = (ch>='A' && ch<='Z') ? (ch.charCodeAt(0)-65) : -1;
    setPreviewIndex(i);
    pushState({ mode:3, speed, currentIndex: i, word:word });
    curIdx++;
    return;
  }
}

function startLoop(){
  if (running) return;
  running=true; curIdx=0;
  function run(){
    if (!running) return;
    stepOnce();
    loopTimer = setTimeout(run, Math.max(40, Number(speedEl.value) || 300));
  }
  run();
}
function stopLoop(){ running=false; if (loopTimer) clearTimeout(loopTimer); }

startBtn.addEventListener('click', startLoop);
stopBtn.addEventListener('click', stopLoop);
pushBtn.addEventListener('click', stepOnce);

// saved words
const savedList = document.getElementById('savedList');
let saved = JSON.parse(localStorage.getItem('stranger_saved_v1')||'[]');
function refreshSaved(){
  savedList.innerHTML='';
  saved.forEach((w,i)=>{
    const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.marginBottom='6px';
    d.innerHTML = `<div>${w}</div><div><button data-i="${i}">Use</button> <button data-del="${i}">Del</button></div>`;
    savedList.appendChild(d);
  });
  savedList.querySelectorAll('button[data-i]').forEach(b=>b.addEventListener('click', e=>{ const i=b.dataset.i; wordEl.value = saved[i]; }));
  savedList.querySelectorAll('button[data-del]').forEach(b=>b.addEventListener('click', e=>{ const i=b.dataset.del; saved.splice(i,1); localStorage.setItem('stranger_saved_v1', JSON.stringify(saved)); refreshSaved(); }));
}
document.getElementById('saveWord').addEventListener('click', ()=>{
  const w = document.getElementById('saveInput').value.toUpperCase().trim();
  if (!w) return alert('Enter a word');
  saved.unshift(w); saved = Array.from(new Set(saved)).slice(0,30); localStorage.setItem('stranger_saved_v1', JSON.stringify(saved)); refreshSaved();
});
refreshSaved();
</script>
</body>
</html>
