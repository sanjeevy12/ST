<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stranger Lights — Controller</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#071018;color:#e6f6ff;padding:18px}
  .wrap{max-width:900px;margin:0 auto}
  h1{text-align:center}
  .controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px}
  select,input,button{padding:8px 10px;border-radius:6px;border:1px solid #2b6;background:#062b2b;color:#fff}
  input[type="text"]{min-width:260px}
  .info{margin-top:12px;color:#aaddff;text-align:center}
  .preview{display:grid;grid-template-columns:repeat(10,56px);gap:8px;justify-content:center;margin-top:10px}
  .preview .cell{width:48px;height:48px;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;border-radius:6px}
  .saved-list{max-height:160px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Stranger Lights — Controller (Emulator)</h1>

  <div class="controls">
    <select id="modeSel">
      <option value="0">All Blink</option>
      <option value="1">Random Blink</option>
      <option value="2">Custom Word</option>
      <option value="3">Scroll</option>
    </select>

    <input id="speed" type="number" min="20" max="5000" value="300" /> ms

    <input id="word" type="text" placeholder="Type custom word (A–Z only)" value="HELLO" />

    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <button id="pushInstant">Push Now</button>
  </div>

  <div class="info">This page writes <b>/state</b> to Firebase. Open <b>viewer.html</b> to watch live.</div>

  <div style="margin-top:14px">
    <label>Preview</label>
    <div id="preview" class="preview"></div>
  </div>

  <div style="margin-top:12px">
    <label>Saved Words</label>
    <div class="saved-list" id="savedList"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="saveInput" type="text" placeholder="word to save" />
      <button id="saveWord">Save</button>
    </div>
  </div>
</div>

<!-- Firebase libs -->
<script src="https://www.gstatic.com/firebasejs/9.32.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.32.0/firebase-database-compat.js"></script>

<script>
// ===== REAL FIREBASE CONFIG (WORKING) =====
const firebaseConfig = {
  apiKey: "AIzaSyC5DEtnD9UThmAblQ1iF5YXQypXtfVCp_s",
  authDomain: "stranger-things-c37aa.firebaseapp.com",
  databaseURL: "https://stranger-things-c37aa-default-rtdb.firebaseio.com",
  projectId: "stranger-things-c37aa",
  storageBucket: "stranger-things-c37aa.appspot.com",
  messagingSenderId: "841392728122",
  appId: "1:841392728122:web:64dd307f50769d03eb6d03",
  measurementId: "G-278D2DZNSB"
};
// =========================================

firebase.initializeApp(firebaseConfig);
console.log("Firebase initialized");

const db = firebase.database();
const stateRef = db.ref("/state");

// Build preview A–Z
const preview = document.getElementById('preview');
const previewCells = [];
for (let i=0;i<26;i++){
  const div = document.createElement('div');
  div.className = 'cell';
  div.textContent = String.fromCharCode(65+i);
  preview.appendChild(div);
  previewCells.push(div);
}

function clearPreview(){ previewCells.forEach(c=>c.style.background='#111'); }
function setPreviewIndex(i){ clearPreview(); if (i>=0) previewCells[i].style.background='#ff4b4b'; }
function setPreviewMask(mask){
  for(let i=0;i<26;i++) previewCells[i].style.background = (mask & (1<<i)) ? '#ff4b4b':'#111';
}

function pushState(obj){
  obj.timestamp = Date.now();
  stateRef.set(obj).then(()=>{
    console.log("State Updated:", obj);
  }).catch(e=>console.error(e));
}

// Controller logic
let running=false;
let loopTimer=null;
let curIdx=0;

function stepOnce(){
  const mode = Number(document.getElementById("modeSel").value);
  const speed = Number(document.getElementById("speed").value) || 300;
  const word = document.getElementById("word").value.toUpperCase().replace(/[^A-Z]/g,'');

  // All Blink
  if (mode === 0){
    const mask = (curIdx % 2 === 0) ? ((1<<26)-1) : 0;
    setPreviewMask(mask);
    pushState({mode, speed, mask, word});
    curIdx++;
    return;
  }

  // Random
  if (mode === 1){
    let mask = 0;
    for (let i=0;i<26;i++) if (Math.random() < 0.3) mask |= (1<<i);
    setPreviewMask(mask);
    pushState({mode, speed, mask, word});
    return;
  }

  // Custom Word
  if (mode === 2){
    if (!word){ pushState({mode, speed, currentIndex:-1, word}); return; }
    const idx = word[curIdx % word.length].charCodeAt(0) - 65;
    setPreviewIndex(idx);
    pushState({mode, speed, currentIndex:idx, word});
    curIdx++;
    return;
  }

  // Scroll
  if (mode === 3){
    if (!word){ pushState({mode, speed, currentIndex:-1, word}); return; }
    const idx = word[curIdx % word.length].charCodeAt(0) - 65;
    setPreviewIndex(idx);
    pushState({mode, speed, currentIndex:idx, word});
    curIdx++;
    return;
  }
}

function startLoop(){
  if (running) return;
  running = true;
  curIdx = 0;
  function run(){
    if (!running) return;
    stepOnce();
    loopTimer = setTimeout(run, Number(document.getElementById("speed").value));
  }
  run();
}

document.getElementById("startBtn").onclick = startLoop;
document.getElementById("stopBtn").onclick = ()=>{ running=false; clearTimeout(loopTimer); };
document.getElementById("pushInstant").onclick = stepOnce;

// Saved words
const savedList = document.getElementById('savedList');
let saved = JSON.parse(localStorage.getItem("savedWords") || "[]");

function refreshSaved(){
  savedList.innerHTML = "";
  saved.forEach((w,i)=>{
    const div = document.createElement("div");
    div.innerHTML = `<div style="display:flex;justify-content:space-between;">
      <span>${w}</span>
      <span>
        <button onclick="wordEl.value='${w}'">Use</button>
        <button onclick="deleteWord(${i})">Delete</button>
      </span></div>`;
    savedList.appendChild(div);
  });
}
function deleteWord(i){
  saved.splice(i,1);
  localStorage.setItem("savedWords", JSON.stringify(saved));
  refreshSaved();
}

document.getElementById("saveWord").onclick = ()=>{
  const v = document.getElementById("saveInput").value.toUpperCase().replace(/[^A-Z]/g,'');
  if (!v) return;
  saved.unshift(v);
  saved = [...new Set(saved)]; // remove duplicates
  localStorage.setItem("savedWords", JSON.stringify(saved));
  refreshSaved();
};

refreshSaved();
</script>
</body>
</html>
