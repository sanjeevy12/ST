<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stranger Lights — Viewer</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#0b0b0b;color:#eee;padding:18px}
  .wrap{max-width:980px;margin:0 auto}
  h1{text-align:center}
  .grid{display:grid;grid-template-columns:repeat(10,1fr);gap:10px;justify-items:center;margin-top:18px}
  .cell{width:64px;height:64px;border-radius:8px;background:#222;display:flex;align-items:center;justify-content:center;transition:all .12s}
  .cell.on{background:#ff3b3b;transform:scale(1.07);box-shadow:0 12px 32px rgba(255,59,59,.14)}
  .letter{font-weight:700;color:#111}
  .status{display:flex;gap:12px;justify-content:center;margin-top:12px;color:#aaa}
  .small{font-size:13px;color:#bbb}
  nav{display:flex;justify-content:center;gap:12px;margin-bottom:8px}
  nav a{color:#9fe;text-decoration:none}
</style>
</head>
<body>
<nav>
  <a href="/ST/index.html" target="_self">Viewer</a>
  <a href="/ST/controller.html" target="_blank">Controller</a>
</nav>

<div class="wrap">
  <h1>Stranger Lights — Viewer</h1>

  <div class="status">
    <div class="small" id="modeText">Mode: —</div>
    <div class="small">Speed: <span id="speedText">—</span> ms</div>
    <div class="small">Word: <span id="wordText">—</span></div>
    <div class="small">Updated: <span id="tsText">—</span></div>
  </div>

  <div id="board" class="grid"></div>
</div>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/9.32.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.32.0/firebase-database-compat.js"></script>

<script>
// ===== FIREBASE CONFIG (stranger-things-ce82d) =====
const firebaseConfig = {
  apiKey: "AIzaSyAfPaTHjXVbvduLyNCpKkA5gD6QYzn-56c",
  authDomain: "stranger-things-ce82d.firebaseapp.com",
  databaseURL: "https://stranger-things-ce82d-default-rtdb.firebaseio.com",
  projectId: "stranger-things-ce82d",
  storageBucket: "stranger-things-ce82d.appspot.com",
  messagingSenderId: "855730758180",
  appId: "1:855730758180:web:08558e3ce2011336996eb1"
};
// ===================================================

firebase.initializeApp(firebaseConfig);
console.log("Firebase initialized (viewer)", firebaseConfig.projectId);

const db = firebase.database();
const stateRef = db.ref("/state");

// Build 26-letter board A..Z
const board = document.getElementById('board');
const letters = [];
for (let i = 0; i < 26; ++i) {
  const ch = String.fromCharCode(65 + i);
  const cell = document.createElement('div');
  cell.className = 'cell'; cell.id = 'L' + ch;
  const span = document.createElement('div'); span.className='letter'; span.textContent = ch;
  cell.appendChild(span); board.appendChild(cell);
  letters.push(cell);
}

function setOn(idx, on){ if (letters[idx]) letters[idx].classList.toggle('on', !!on); }

const modeText = document.getElementById('modeText');
const speedText = document.getElementById('speedText');
const wordText = document.getElementById('wordText');
const tsText = document.getElementById('tsText');

stateRef.on('value', snap => {
  const s = snap.val();
  if (!s) return;
  const mode = s.mode ?? -1;
  const speed = s.speed ?? 0;
  const word = s.word ?? '';
  const ts = s.timestamp ?? Date.now();
  const modeNames = {0:'All Blink',1:'Random',2:'Custom Word',3:'Scroll'};
  modeText.textContent = 'Mode: ' + (modeNames[mode] ?? mode);
  speedText.textContent = speed;
  wordText.textContent = word || '—';
  tsText.textContent = new Date(ts).toLocaleTimeString();

  if (typeof s.mask !== 'undefined' && s.mask !== null) {
    const mask = Number(s.mask) >>> 0;
    for (let i=0;i<26;i++) setOn(i, (mask & (1<<i))!==0);
    return;
  }

  if (typeof s.currentIndex !== 'undefined' && s.currentIndex !== null) {
    for (let i=0;i<26;i++) setOn(i, false);
    const idx = Number(s.currentIndex);
    if (idx >=0 && idx<26) setOn(idx, true);
    return;
  }

  for (let i=0;i<26;i++) setOn(i,false);
});
</script>
</body>
</html>
