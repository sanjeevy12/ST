<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stranger Lights — Viewer</title>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{ --led:#ff3b3b; --cell-size:44px }
  html,body{height:100%;margin:0;font-family:Rubik,system-ui,Arial;background:#040506;color:#fff}
  .wrap{max-width:1200px;margin:18px auto;padding:12px}
  header{display:flex;justify-content:space-between;align-items:center}
  h1{margin:0;font-size:18px}
  .image-wrap{position:relative;max-width:980px;margin:12px auto}
  .bg{width:100%;height:auto;border-radius:8px;box-shadow:0 20px 40px rgba(0,0,0,0.7)}
  .hotspot{position:absolute;width:var(--cell-size);height:var(--cell-size);transform:translate(-50%,-50%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;color:#111;background:rgba(255,255,255,0.02);pointer-events:none;transition:filter .08s, transform .12s, box-shadow .12s}
  .hotspot .lbl{ display:none }
  .hotspot.on{ background:var(--led); box-shadow:0 16px 42px var(--glow, rgba(255,59,59,0.2)); transform:translate(-50%,-50%) scale(1.04) }
  .status{display:flex;gap:12px;justify-content:center;margin-top:8px;color:#99b;font-size:13px}
  .controls{display:flex;gap:8px;justify-content:center;margin-top:6px}
  @media (max-width:940px){ :root{--cell-size:42px} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Stranger Lights — Viewer</h1>
    <div class="controls">
      <button id="toggleMarkers">Toggle markers</button>
      <button id="reloadPos">Reload positions</button>
    </div>
  </header>

  <div class="status"><div id="modeText">Mode: —</div><div id="wordText">Word: —</div></div>

  <div class="image-wrap" id="imageWrap">
    <img id="bg" class="bg" src="wall-bg.png" alt="wall-bg.png">
  </div>
</div>

<script>
const STORAGE_POS = 'st_positions_v1';
const STORAGE_STATE = 'st_last_state_v1';
const imageWrap = document.getElementById('imageWrap'), bg = document.getElementById('bg');
const modeText = document.getElementById('modeText'), wordText = document.getElementById('wordText');

let positions = [];
function loadPositions(){
  try{ const p = JSON.parse(localStorage.getItem(STORAGE_POS)); if(Array.isArray(p) && p.length===26){ positions=p; return; } }catch(e){}
  const rows=[8,9,9], y=[20,44,68]; const out=[]; for(let r=0;r<rows.length;r++){ for(let i=0;i<rows[r];i++){ out.push({x: +( ((i+1)/(rows[r]+1))*100 ).toFixed(2), y: y[r]}); } } positions=out;
}
loadPositions();

const hotspotEls = [];
function createHotspots(){
  hotspotEls.forEach(h=>h.remove()); hotspotEls.length=0;
  for(let i=0;i<26;i++){
    const el = document.createElement('div');
    el.className='hotspot'; el.dataset.i=i;
    el.innerHTML = `<div class="lbl">${String.fromCharCode(65+i)}</div>`;
    const p = positions[i]||{x:5,y:5};
    el.style.left = p.x + '%'; el.style.top = p.y + '%';
    imageWrap.appendChild(el); hotspotEls.push(el);
  }
}
createHotspots();

/* util */
function clearAll(){ hotspotEls.forEach(h=>{ h.classList.remove('on'); h.style.filter='none'; }); }
function applyMask(mask){ clearAll(); for(let i=0;i<26;i++) if(mask & (1<<i)) hotspotEls[i].classList.add('on'); }
function setIndex(idx){ clearAll(); if(idx>=0 && idx<26) hotspotEls[idx].classList.add('on'); }

let flickInterval = null;
function startFlicker(intensity){
  stopFlicker();
  const iv = Math.max(0, Math.min(100, Number(intensity||30)));
  flickInterval = setInterval(()=> {
    hotspotEls.forEach(h=>{
      if(!h.classList.contains('on')) { h.style.filter='none'; return; }
      const jitter = (Math.random()*0.4 - 0.12) * (iv/50);
      const b = Math.max(0.7, 1 + jitter);
      h.style.filter = `brightness(${b})`;
    });
  }, 100);
}
function stopFlicker(){ if(flickInterval) clearInterval(flickInterval); flickInterval=null; hotspotEls.forEach(h=> h.style.filter='none'); }

/* receive via BroadcastChannel */
const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('st-lights') : null;
if(bc){ bc.onmessage = (ev)=> handleState(ev.data); console.log('Viewer listening'); }

/* fallback polling localStorage */
let lastSeen = 0;
setInterval(()=> {
  try{
    const raw = localStorage.getItem(STORAGE_STATE);
    if(!raw) return;
    const s = JSON.parse(raw);
    if(!s) return;
    if(s.timestamp && s.timestamp > lastSeen){ lastSeen = s.timestamp; handleState(s); }
  }catch(e){}
}, 300);

/* apply state */
function handleState(s){
  modeText.textContent = 'Mode: ' + (s.mode || s.mode === 0 ? s.mode : s.mode);
  wordText.textContent = 'Word: ' + (s.word || '—');
  // If color provided, use it
  if(s.color){ document.documentElement.style.setProperty('--led', s.color); hotspotEls.forEach(h => h.style.setProperty('--glow', s.color + '33')); }
  if(typeof s.mask !== 'undefined' && s.mask !== null){ applyMask(Number(s.mask)); startFlicker(s.flicker || s.speed || 30); return; }
  if(typeof s.currentIndex !== 'undefined' && s.currentIndex !== null){ if(s.currentIndex>=0) setIndex(Number(s.currentIndex)); else clearAll(); startFlicker(s.flicker || s.speed || 30); return; }
}

/* UI helpers */
document.getElementById('toggleMarkers').addEventListener('click', ()=>{
  hotspotEls.forEach(h=> { const l = h.querySelector('.lbl'); l.style.display = (l.style.display === 'block') ? 'none' : 'block'; } );
});
document.getElementById('reloadPos').addEventListener('click', ()=>{ loadPositions(); hotspotEls.forEach((h,i)=>{ const p=positions[i]||{x:5,y:5}; h.style.left=p.x+'%'; h.style.top=p.y+'%'; }); });

/* init */
document.documentElement.style.setProperty('--led', '#ff3b3b');
hotspotEls.forEach(h=> h.style.setProperty('--glow', '#ff3b3b33'));
window.__viewer = { hotspotEls, loadPositions, handleState };
</script>
</body>
</html>
